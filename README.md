# OAK-D Lite Webcam Utility for Mac

## 概要

このプロジェクトは、Luxonis社のOAK-D LiteカメラをmacOS上で手軽に高性能なWebカメラとして利用するためのユーティリティです。
**基本的な使い方として、`src/uvc_handler.py` スクリプトを実行している間のみ、OAK-D LiteがWebカメラとして認識されます。**
その他、デバイスのブートローダーやアプリケーションパイプラインの書き換え、UVCデバイスとして初期化した後にスクリプトを終了する高度なオプションも提供します。

## 主な機能

*   **一時的なWebカメラ化 (デフォルト)**: `src/uvc_handler.py` スクリプトを実行している間、OAK-D LiteのカラーカメラをUVC (USB Video Class) デバイスとして動作させ、Mac標準のWebカメラとして利用可能にします。これが本ユーティリティの主な使用方法です。
*   **パイプライン設定**: 4K解像度からのダウンスケールや720pなど、複数の解像度設定に対応したパイプラインを提供します。
*   **デバイスへの書き込み (高度なオプション)**:
    *   ブートローダーの書き換え (`-fb` オプション)
    *   アプリケーションパイプラインの書き換え (`-f` オプション)
*   **スタンドアロン動作 (高度なオプション)**: UVC初期化後にスクリプトを終了し、デバイス単体でWebカメラとして動作させる機能 (`-l` オプション) を提供します。

## `src/uvc_handler.py` の詳細

`src/uvc_handler.py` は、OAK-D LiteをUVCデバイスとして制御するためのコアスクリプトです。
**コマンドライン引数なしで実行するのが標準的な使用方法で、スクリプト実行中のみWebカメラとして機能します。**
その他、特定の目的のための高度なコマンドライン引数も用意されています。

### コマンドラインオプション

*   **引数なし (デフォルト)**:
    *   スクリプトを実行すると、接続されているOAK-D Liteが一時的にUVCデバイスとして動作します。スクリプト実行中のみWebカメラとして利用可能です。これが最も一般的な使用方法です。

以下のオプションは、特定の高度な操作を行うためのものです。

*   **`-fb` または `--flash-bootloader`**:
    *   OAK-D Liteデバイスのブートローダーを書き換えます。
    *   **使用ケース**: Luxonisから新しいブートローダーが提供された場合や、ブートローダーの破損が疑われる場合。
    *   **注意点**: デバイスの動作に深刻な影響を与える可能性があるため、慎重に実行してください。書き換え後はデバイスの電源を再投入する必要があります。

*   **`-f` または `--flash-app`**:
    *   スクリプト内の `getMinimalPipeline()` で定義されたUVCカメラ設定（アプリケーションパイプライン）をデバイスのフラッシュメモリに書き込みます。
    *   **使用ケース**: OAK-D LiteをPC接続時に常に特定のWebカメラ設定で永続的に使用したい場合。
    *   **注意点**: 既存のアプリケーションパイプラインは上書きされます。書き換え後はデバイスの電源を再投入する必要があります。

*   **`-l` または `--load-and-exit`**:
    *   OAK-D LiteをUVCデバイスとして初期化した後、スクリプトを終了します。デバイスのウォッチドッグタイマーが無効化され、ホストPCからの通信なしに動作し続けます。
    *   **使用ケース**: スクリプトを常駐させずにWebカメラ機能を利用したいが、デバイス設定を永続化したくない場合。
    *   **注意点**: 再度DepthAIライブラリ経由でデバイスに接続する場合、電源の再投入が必要になることがあります。

### 主要な関数

*   **`getMinimalPipeline()`**:
    *   1080p解像度、NV12フォーマットの基本的なUVCパイプラインを構築して返します。FPSは30に設定されます。
    *   カメラ名は "MinimalUVCCam\_1080p" となります。

*   **`getPipeline()`**:
    *   より高度な設定が可能なUVCパイプラインを構築します。
    *   `enable_4k` フラグにより、4K解像度から1080pへのダウンスケール、または720p解像度を選択できます。
    *   カメラ名は "FlashedCam\_1080p\_NV12" となります。

*   **`flash(pipeline=None)`**:
    *   デバイスのブートローダーまたは指定されたパイプラインをフラッシュメモリに書き込みます。
    *   `pipeline`引数が `None` の場合はブートローダーを、パイプラインオブジェクトが渡された場合はそのパイプラインを書き込みます。
    *   書き込みの進捗状況を表示します。

*   **`handle_flash_bootloader()`**:
    *   `-fb` オプションが指定された場合に呼び出され、`flash()` 関数を使ってブートローダーを書き込みます。

*   **`handle_flash_app()`**:
    *   `-f` オプションが指定された場合に呼び出され、`flash(getMinimalPipeline)` を実行して、`getMinimalPipeline` で定義された設定をデバイスに書き込みます。

*   **`handle_load_and_exit()`**:
    *   `-l` オプションが指定された場合に呼び出されます。
    *   環境変数 `DEPTHAI_WATCHDOG` を "0" に設定してウォッチドッグを無効化します。
    *   `getPipeline()` で定義されたパイプラインでデバイスを初期化し、その後スクリプトプロセスを終了させます。

*   **`run_uvc_device()`**:
    *   コマンドライン引数なしでスクリプトが実行された場合に呼び出されます。
    *   `getMinimalPipeline()` で定義されたパイプラインを使用してデバイスをUVCモードで起動し、スクリプトが実行されている間、Webカメラとして機能させます。Ctrl+Cで終了します。

*   **`main()`**:
    *   コマンドライン引数を解析し、対応するハンドラ関数（`handle_flash_bootloader`, `handle_flash_app`, `handle_load_and_exit`）を呼び出すか、引数がない場合は `run_uvc_device()` を呼び出します。
    *   `-fb` と `-f` オプションの同時指定はエラーとして扱います。

## システム構成 (参考)

(このセクションは元のREADMEから流用・調整可能です。メニューバーアプリやPyInstallerによるビルドなど、現在の `uvc_handler.py` の範囲を超える部分は、プロジェクトの進捗に合わせて更新してください。)

## 技術要素

*   **プログラミング言語**: Python 3.x
*   **主要ライブラリ**:
    *   `depthai`: OAK-D Liteの制御、UVC (USB Video Class) 化機能の利用。
    *   標準ライブラリ: `time`, `argparse`, `os`, `signal` など。

## セットアップ (開発者向け)

1.  **開発環境のセットアップ**:
    *   Python 3.8以上を推奨。
    *   仮想環境の利用を推奨します。
    *   必要なライブラリをインストール:
        ```bash
        pip install -r requirements.txt
        ```
        (`requirements.txt` には `depthai` などを記載)

2.  **実行方法**:
    *   **基本的なUVCデバイスとしての実行 (推奨される主な使用方法)**:
        ```bash
        python src/uvc_handler.py
        ```
        このコマンドでスクリプトを実行すると、スクリプトが動作している間のみOAK-D LiteがWebカメラとして利用可能になります。

    *   **高度なオプション**:
        *   アプリケーションパイプラインの書き込み (設定をデバイスに永続化):
            ```bash
            python src/uvc_handler.py -f
            ```
        *   ブートローダーの書き込み (特殊なメンテナンス用途):
            ```bash
            python src/uvc_handler.py -fb
            ```
        *   UVC初期化後にスクリプト終了 (デバイス単体で動作、設定は非永続):
            ```bash
            python src/uvc_handler.py -l
            ```

## 注意点・既知の問題

*   **`depthai` のバージョン**: UVC機能は比較的新しい機能のため、`depthai` のバージョンによって動作が異なる場合があります。`requirements.txt` で指定されたバージョンを使用することを推奨します。
*   **デバイスの認識**: スクリプト実行前にOAK-D LiteがPCに正しく接続され、認識されていることを確認してください。
*   **フラッシュ書き込み**: ブートローダーやアプリケーションパイプラインの書き込みは、デバイスの動作に影響を与える可能性があるため、慎重に行ってください。書き込み後は、指示に従いデバイスの電源を再投入してください。

## 今後の改善点 (TODO)

*   [ ] メニューバー制御アプリケーション (`menu_bar_control.py`) の開発と統合。
*   [ ] `PyInstaller` を用いたスタンドアロンアプリケーション化。
*   [ ] `launchd` サービスによる自動起動設定。
*   [ ] より詳細なエラーハンドリングとユーザーフレンドリーなフィードバック。
*   [ ] GUI設定画面の追加 (カメラ解像度/FPS選択など)。

## ライセンス

このプロジェクトは [ライセンス名 (例: MIT License)] のもとで公開されます。詳細は `LICENSE` ファイルを参照してください。
