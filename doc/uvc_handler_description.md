# `src/uvc_handler.py` スクリプト解説

このスクリプトは、DepthAIカメラデバイスをUVC（USB Video Class）デバイスとして動作させ、ウェブカメラのように扱えるようにするためのものです。また、デバイスのファームウェア（ブートローダーやアプリケーションパイプライン）を書き換える機能も備えています。

## 主な処理の流れ

1.  **コマンドライン引数の解析**:
    *   スクリプト実行時に指定できるオプションを定義し、受け取ります。
    *   `-fb` (`--flash-bootloader`): デバイスのブートローダーを書き換える場合に指定します。
    *   `-f` (`--flash-app`): デバイスのアプリケーションパイプライン（カメラ設定など）を書き換える場合に指定します。
    *   `-l` (`--load-and-exit`): カメラをUVCデバイスとして起動した後、このスクリプト自体は終了させたい場合に指定します。この際、デバイスがホストPCからの定期的な通信なしに動作し続けられるように、ウォッチドッグタイマーを無効にします。

2.  **DepthAIライブラリの初期化と設定**:
    *   `depthai` ライブラリをインポートします。
    *   `--load-and-exit` オプションが指定された場合は、DepthAIライブラリをインポートする前に環境変数 `DEPTHAI_WATCHDOG` を `0` に設定し、ウォッチドッグ機能を無効にします。

3.  **カメラパイプラインの定義 (`getPipeline` 関数)**:
    *   DepthAIデバイス上で実行される処理の流れ（パイプライン）を定義します。
    *   **カラーカメラの設定**:
        *   カラーカメラノードを作成します。
        *   カメラの接続ポートを指定します。
        *   解像度を設定します（デフォルトは1080p、4Kも選択可能ですがコード上では無効化されています）。
    *   **UVC出力ノードの作成**:
        *   カメラからの映像をUSB経由でPCに送信するためのUVC出力ノードを作成します。
        *   カラーカメラのビデオ出力をUVCノードの入力に接続します。
    *   **デバイス設定**:
        *   UVCデバイスとしての設定（解像度1920x1080、フレームタイプNV12など）を定義します。
        *   オプションでUVCカメラ名も設定できます（コード上ではコメントアウトされています）。
        *   これらの設定をパイプラインに適用します。
    *   作成したパイプラインオブジェクトを返します。

4.  **ファームウェア書き換え処理 (`flash` 関数)**:
    *   接続されているDepthAIデバイスのブートローダーにアクセスします。
    *   引数としてパイプラインが渡された場合（`--flash-app` 時）は、そのパイプラインをアプリケーションとしてデバイスに書き込みます。
    *   パイプラインが渡されなかった場合（`--flash-bootloader` 時）は、ブートローダー自体を書き換えます。
    *   書き換えの進捗状況をパーセンテージで表示します。
    *   書き換えにかかった時間を表示します。

5.  **メイン処理**:
    *   **書き換えモードの場合**:
        *   `--flash-bootloader` または `--flash-app` が指定されている場合、対応する `flash` 関数を呼び出します。
        *   書き換えが完了したら、デバイスの電源を入れ直すようメッセージを表示してスクリプトを終了します。
    *   **ロード＆終了モードの場合**:
        *   `--load-and-exit` が指定されている場合、`getPipeline` 関数で定義されたパイプラインを使用してDepthAIデバイスを起動します。
        *   デバイスが起動したことを知らせるメッセージと、UVCビューアで確認するよう促すメッセージを表示します。
        *   その後、このスクリプトプロセスを強制的に終了させます。これにより、スクリプトは終了しますが、カメラデバイスはUVCデバイスとして動作し続けます。
    *   **標準UVCロードモードの場合（引数なし）**:
        *   上記のいずれの引数も指定されなかった場合、これがデフォルトの動作です。
        *   UVCデバイスの設定（解像度1920x1080、フレームタイプNV12）を直接作成します。
        *   この設定を使用してDepthAIデバイスを初期化します。
        *   `getPipeline` 関数で定義されたパイプラインをデバイス上で開始します。
        *   デバイスが起動したことを知らせるメッセージと、UVCビューアで確認するよう促すメッセージ、そしてCtrl+Cで終了できることを表示します。
        *   スクリプトはループ処理に入り、ユーザーがCtrl+Cで中断するまで待機します。この間、ホストPCはデバイスのウォッチドッグタイマーをリセットし続けるため、デバイスは動作を継続します。
